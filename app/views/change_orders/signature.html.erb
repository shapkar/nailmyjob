<% content_for :title, "Sign Change Order ##{@change_order.co_number} - NailMyJob" %>

<div class="max-w-xl mx-auto pb-20" data-controller="signature">
  <%# Header %>
  <header class="mb-8">
    <%= link_to job_change_order_path(@job, @change_order), class: "inline-flex items-center gap-2 text-stone-500 hover:text-stone-900 mb-6 transition-colors font-medium text-sm" do %>
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
      Back to change order
    <% end %>
    
    <h1 class="text-3xl sm:text-4xl mb-2">Sign Change Order</h1>
    <p class="text-stone-500">CO #<%= @change_order.co_number %> Â· <%= @change_order.formatted_amount %></p>
  </header>

  <%# Summary Card %>
  <div class="card p-6 mb-6">
    <h2 class="font-bold text-stone-900 mb-3">Change Summary</h2>
    <p class="text-stone-700 mb-4"><%= @change_order.description %></p>
    <div class="pt-4 border-t border-stone-100 space-y-2">
      <div class="flex justify-between text-sm">
        <span class="text-stone-500">Amount:</span>
        <span class="font-bold <%= @change_order.amount.positive? ? 'text-emerald-600' : 'text-red-600' %>">
          <%= @change_order.formatted_amount %>
        </span>
      </div>
      <% if @change_order.delays_schedule %>
        <div class="flex justify-between text-sm">
          <span class="text-stone-500">Schedule Impact:</span>
          <span class="font-medium text-amber-600"><%= @change_order.schedule_impact_display %></span>
        </div>
      <% end %>
    </div>
  </div>

  <%# Signature Form %>
  <%= form_with url: submit_signature_job_change_order_path(@job, @change_order), 
                method: :post, 
                class: "space-y-6",
                data: { signature_target: "form" } do |f| %>
    
    <%# Signer Info %>
    <div class="bg-white rounded-xl border border-stone-200">
      <div class="px-5 py-4 border-b border-stone-100">
        <h2 class="font-bold text-stone-900">Signer Information</h2>
      </div>
      <div class="p-5 space-y-5">
        <div>
          <label class="block text-sm font-bold text-stone-700 mb-1">Full Name</label>
          <%= text_field_tag :signer_name, 
              @job.client&.name, 
              required: true,
              placeholder: "Enter your full name" %>
        </div>
        <div>
          <label class="block text-sm font-bold text-stone-700 mb-1">Email Address</label>
          <%= email_field_tag :signer_email, 
              @job.client&.email, 
              placeholder: "your@email.com" %>
        </div>
      </div>
    </div>

    <%# Signature Pad %>
    <div class="bg-white rounded-xl border border-stone-200">
      <div class="px-5 py-4 border-b border-stone-100 flex items-center justify-between">
        <h2 class="font-bold text-stone-900">Signature</h2>
        <button type="button" 
                class="text-sm text-red-600 hover:text-red-700 font-medium"
                data-action="click->signature#clear">
          Clear
        </button>
      </div>
      <div class="p-5">
        <div class="border-2 border-dashed border-stone-200 rounded-xl bg-stone-50 relative">
          <canvas data-signature-target="canvas"
                  class="w-full h-48 touch-none"
                  style="touch-action: none;"></canvas>
        </div>
        <p class="text-xs text-stone-400 mt-2 text-center">Sign above using your finger or mouse</p>
        <%= hidden_field_tag :signature_data, "", data: { signature_target: "data" } %>
      </div>
    </div>

    <%# Legal Agreement %>
    <div class="bg-stone-50 rounded-xl p-5">
      <label class="flex items-start gap-3 cursor-pointer">
        <%= check_box_tag :agree_to_terms, "1", false, required: true, class: "mt-1 w-5 h-5 rounded border-stone-300 text-emerald-600 focus:ring-emerald-500" %>
        <span class="text-sm text-stone-600 leading-relaxed">
          I agree to this change order. I understand this will adjust the project total by 
          <strong class="<%= @change_order.amount.positive? ? 'text-emerald-600' : 'text-red-600' %>">
            <%= @change_order.formatted_amount %>
          </strong>.
          <%= @change_order.delays_schedule ? "This may also affect the project timeline." : "" %>
        </span>
      </label>
    </div>

    <%# Hidden geolocation field %>
    <%= hidden_field_tag :geolocation, "", data: { signature_target: "geolocation" } %>

    <%# Submit %>
    <div class="flex flex-col gap-3 pt-4">
      <%= submit_tag "Sign Change Order", 
          class: "btn-primary w-full !text-xl !py-4 cursor-pointer",
          data: { signature_target: "submit", action: "click->signature#prepareSubmit" } %>
      
      <p class="text-xs text-stone-400 text-center">
        By signing, you agree to the terms above. This signature is legally binding under the ESIGN Act.
      </p>
    </div>
  <% end %>
</div>
