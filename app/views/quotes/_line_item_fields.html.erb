<%# Helper variables %>
<% is_range = f.object.is_range? %>

<div class="line-item-card group relative bg-white border border-stone-200 rounded-xl shadow-sm mb-4 overflow-hidden transition-all hover:shadow-md hover:border-stone-300"
     data-new-record="<%= f.object.new_record? %>"
     data-controller="nested-form line-item"
     data-line-item-is-range-value="<%= is_range %>">

  <div class="flex flex-col md:flex-row items-stretch">
    
    <%# LEFT SECTION: The Core "What" (Description) %>
    <div class="flex-1 p-5 md:p-6 flex flex-col justify-center border-b md:border-b-0">
      <div class="space-y-5">
        <div>
          <label class="text-sm font-bold text-stone-400 uppercase tracking-wider block mb-2">Item Description</label>
          <%= f.text_field :description, 
              placeholder: "e.g. Master Bathroom Vanity", 
              class: "w-full text-xl font-bold text-stone-900 placeholder:text-stone-300 border-0 border-b-2 border-stone-100 focus:border-emerald-500 focus:ring-0 px-0 py-2 bg-transparent transition-colors" %>
        </div>
            
        <%# Allowance Toggle - Large Card Style for easy tapping %>
        <label class="flex items-center gap-4 p-3 rounded-lg border border-stone-200 bg-stone-50 cursor-pointer transition-all hover:bg-stone-100 has-[:checked]:bg-amber-50 has-[:checked]:border-amber-200 group/allowance">
          <%# Large Switch %>
          <div class="relative flex-shrink-0">
            <%= f.check_box :is_allowance, 
                class: "peer sr-only", 
                data: { action: "change->line-item#toggleAllowance", line_item_target: "allowanceToggle" } %>
            <div class="w-12 h-7 bg-stone-300 peer-focus:outline-none rounded-full peer peer-checked:bg-amber-500 transition-all"></div>
            <div class="absolute left-1 top-1 bg-white w-5 h-5 rounded-full transition-all peer-checked:translate-x-5 shadow-sm"></div>
          </div>
          
          <div class="flex flex-col">
            <span class="text-base font-bold text-stone-600 group-has-[:checked]/allowance:text-amber-800 transition-colors" data-line-item-target="allowanceLabel">Allowance Item</span>
            <span class="text-xs text-stone-400 font-medium group-has-[:checked]/allowance:text-amber-600/70">Budget placeholder for client selection</span>
          </div>
        </label>
      </div>
    </div>

    <%# RIGHT SECTION: The "Details & Cost" %>
    <div class="md:w-[420px] bg-stone-50/80 md:border-l border-stone-100 p-5 md:p-6 flex flex-col justify-center relative group/price">
      
      <%# Delete Button (Desktop - Top Right) %>
      <button type="button" 
              class="hidden md:flex absolute top-4 right-4 text-stone-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100 focus:opacity-100 items-center gap-1"
              data-action="click->nested-form#remove"
              title="Remove item">
        <span class="text-xs font-bold uppercase tracking-wide">Remove</span>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
      </button>

      <div class="space-y-6">
        <%# Meta Data Row (Category + Quality) %>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-xs font-bold text-stone-400 uppercase tracking-wider block mb-2">Category</label>
            <div class="relative">
              <%= f.select :category, 
                  LineItem.categories.keys.map { |k| [k.titleize, k] }, 
                  {}, 
                  class: "w-full appearance-none bg-white border border-stone-200 text-stone-700 text-sm font-bold py-2.5 pl-3 pr-8 rounded-lg focus:border-emerald-500 focus:ring-emerald-500 cursor-pointer hover:border-stone-300 transition-colors shadow-sm" %>
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-stone-400">
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
              </div>
            </div>
          </div>
          
          <div>
            <label class="text-xs font-bold text-stone-400 uppercase tracking-wider block mb-2">Quality</label>
            <div class="relative">
              <%= f.select :quality_tier, 
                  LineItem.quality_tiers.keys.map { |k| [k.titleize, k] }, 
                  {}, 
                  class: "w-full appearance-none bg-white border border-stone-200 text-stone-700 text-sm font-bold py-2.5 pl-3 pr-8 rounded-lg focus:border-emerald-500 focus:ring-emerald-500 cursor-pointer hover:border-stone-300 transition-colors shadow-sm" %>
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-stone-400">
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
              </div>
            </div>
          </div>
        </div>

        <%# Price Row %>
        <div>
          <div class="flex items-center justify-between mb-2">
            <label class="text-sm font-bold text-stone-400 uppercase tracking-wider">Estimated Cost</label>
            
            <%# Range Toggle - Large Switch %>
            <label class="inline-flex items-center gap-3 cursor-pointer group/range p-1 -mr-1">
              <span class="text-xs font-bold text-stone-400 group-hover/range:text-stone-600 uppercase tracking-wide transition-colors">Range Mode</span>
              <div class="relative flex-shrink-0">
                <%= f.check_box :is_range, 
                    class: "peer sr-only", 
                    data: { line_item_target: "rangeToggle", action: "change->line-item#toggleRange" } %>
                <div class="w-11 h-6 bg-stone-300 peer-focus:outline-none rounded-full peer peer-checked:bg-emerald-500 transition-all"></div>
                <div class="absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-all peer-checked:translate-x-5 shadow-sm"></div>
              </div>
            </label>
          </div>

          <div class="flex items-center gap-2">
            <div class="relative flex-1">
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-stone-400 font-bold text-lg">$</span>
              <%= f.text_field :range_low, 
                  value: number_with_precision(f.object.range_low, precision: 2, delimiter: ""),
                  placeholder: "0.00",
                  inputmode: "decimal",
                  data: { line_item_target: "rangeLow" },
                  class: "w-full pl-7 pr-3 py-3 rounded-lg border border-stone-200 bg-white text-right font-mono font-bold text-xl text-stone-900 focus:border-emerald-500 focus:ring-emerald-500 shadow-sm transition-all" %>
            </div>

            <div class="<%= is_range ? 'flex' : 'hidden' %> items-center gap-2 flex-1" data-line-item-target="rangeHighWrapper">
              <span class="text-stone-300 font-bold text-xl">â€“</span>
              <div class="relative w-full">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-stone-400 font-bold text-lg">$</span>
                <%= f.text_field :range_high, 
                    value: number_with_precision(f.object.range_high, precision: 2, delimiter: ""),
                    placeholder: "High",
                    inputmode: "decimal",
                    data: { line_item_target: "rangeHigh" },
                    class: "w-full pl-7 pr-3 py-3 rounded-lg border border-stone-200 bg-white text-right font-mono font-bold text-xl text-stone-900 focus:border-emerald-500 focus:ring-emerald-500 shadow-sm transition-all" %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <%# Mobile Delete Button - Bottom of card %>
      <div class="mt-6 flex justify-center md:hidden pt-4 border-t border-stone-200/50">
        <button type="button" 
                class="text-red-500 font-bold text-sm flex items-center gap-2 py-2 px-4 rounded-lg hover:bg-red-50 transition-colors"
                data-action="click->nested-form#remove">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
          Remove Item
        </button>
      </div>
    </div>
  </div>
  
  <%= f.hidden_field :_destroy %>
</div>