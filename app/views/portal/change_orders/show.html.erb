<% content_for :title, "Change Order ##{@change_order.co_number} - #{@job.company.name}" %>

<div class="space-y-8 max-w-2xl mx-auto">
  <%# Status Banner %>
  <% if @change_order.signed? %>
    <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-6 flex items-center gap-4">
      <div class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center shrink-0">
        <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
      <div>
        <p class="font-bold text-emerald-800 text-lg">Change Order Approved</p>
        <p class="text-emerald-600">Signed by <%= @change_order.signer_name %> on <%= @change_order.signed_at&.strftime("%B %d, %Y") %></p>
      </div>
    </div>
  <% elsif @change_order.rejected? %>
    <div class="bg-red-50 border border-red-200 rounded-2xl p-6 flex items-center gap-4">
      <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center shrink-0">
        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
      <div>
        <p class="font-bold text-red-800 text-lg">Change Order Declined</p>
        <p class="text-red-600">This change order was not approved.</p>
      </div>
    </div>
  <% else %>
    <div class="bg-amber-50 border-2 border-amber-200 rounded-2xl p-6">
      <div class="flex items-center justify-between gap-4">
        <div>
          <p class="font-bold text-amber-800 text-lg">Action Required</p>
          <p class="text-amber-700">Please review and sign this change order</p>
        </div>
        <%= link_to portal_change_order_signature_path(@change_order.client_view_token), class: "btn-primary !bg-amber-600 !hover:bg-amber-700 whitespace-nowrap" do %>
          Review & Sign
        <% end %>
      </div>
    </div>
  <% end %>

  <%# Change Order Header %>
  <div class="bg-white rounded-2xl border border-stone-200 overflow-hidden">
    <div class="p-6 border-b border-stone-100">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-xs font-bold uppercase tracking-wide text-stone-400 mb-1">Change Order</p>
          <h1 class="text-2xl font-bold text-stone-900">#<%= @change_order.co_number %></h1>
          <p class="text-stone-500 mt-1">For Job #<%= @job.job_number %></p>
        </div>
        <div class="text-right">
          <p class="text-xs font-bold uppercase tracking-wide text-stone-400 mb-1">Amount</p>
          <p class="text-3xl font-bold <%= @change_order.amount.positive? ? 'text-emerald-600' : 'text-red-600' %>">
            <%= @change_order.formatted_amount %>
          </p>
        </div>
      </div>
    </div>

    <div class="p-6 space-y-6">
      <div>
        <p class="text-xs font-bold uppercase tracking-wide text-stone-400 mb-2">Description</p>
        <p class="text-lg text-stone-900"><%= @change_order.description %></p>
      </div>

      <div class="grid grid-cols-2 gap-6">
        <div>
          <p class="text-xs font-bold uppercase tracking-wide text-stone-400 mb-2">Category</p>
          <div class="flex items-center gap-2">
            <span class="text-xl"><%= @change_order.category_icon %></span>
            <span class="text-stone-900 font-medium"><%= @change_order.category.to_s.titleize %></span>
          </div>
        </div>
        <div>
          <p class="text-xs font-bold uppercase tracking-wide text-stone-400 mb-2">Schedule Impact</p>
          <p class="text-stone-900 font-medium"><%= @change_order.schedule_impact_display %></p>
        </div>
      </div>
    </div>
  </div>

  <%# Impact on Project %>
  <div class="bg-white rounded-2xl border border-stone-200 p-6">
    <p class="text-xs font-bold uppercase tracking-wide text-stone-400 mb-4">Impact on Your Project</p>

    <div class="space-y-3">
      <div class="flex justify-between items-center">
        <span class="text-stone-500">Current Project Total</span>
        <span class="font-mono text-stone-700"><%= @job.current_total_range %></span>
      </div>
      <div class="flex justify-between items-center <%= @change_order.amount.positive? ? 'text-emerald-600' : 'text-red-600' %>">
        <span>This Change Order</span>
        <span class="font-mono font-medium"><%= @change_order.formatted_amount %></span>
      </div>
      <% unless @change_order.signed? %>
        <div class="pt-3 border-t border-dashed border-stone-200">
          <div class="flex justify-between items-center">
            <span class="font-bold text-stone-900">New Total (if approved)</span>
            <span class="font-bold text-lg text-stone-900">
              $<%= number_with_delimiter(@change_order.new_total_low.to_i) %> – $<%= number_with_delimiter(@change_order.new_total_high.to_i) %>
            </span>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <%# Legal Terms %>
  <% if @change_order.legal_boilerplate.present? %>
    <div class="bg-stone-50 rounded-2xl p-6">
      <p class="text-xs font-bold uppercase tracking-wide text-stone-400 mb-3">Terms & Conditions</p>
      <p class="text-sm text-stone-600 whitespace-pre-wrap leading-relaxed"><%= @change_order.legal_boilerplate %></p>
    </div>
  <% end %>

  <%# Sign Button (if not signed) %>
  <% unless @change_order.signed? || @change_order.rejected? %>
    <div class="flex flex-col gap-3 pt-4">
      <%= link_to portal_change_order_signature_path(@change_order.client_view_token), class: "btn-primary w-full !text-xl !py-4 text-center" do %>
        Approve & Sign Change Order
      <% end %>
      <p class="text-xs text-stone-400 text-center">
        By signing, you authorize the additional work described above.
      </p>
    </div>
  <% end %>

  <%# Back to Project %>
  <div class="text-center pt-4">
    <%= link_to portal_job_path(@job.client_view_token), class: "text-emerald-700 hover:text-emerald-800 font-medium" do %>
      ← Back to Project
    <% end %>
  </div>
</div>
